<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết đơn hàng - Admin</title>

    <!-- Load Bootstrap trước khi load layout -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Load Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="layoutContainer">
        <!-- Layout will be loaded here -->
    </div>

    <script>
        // Load layout với scripts theo pattern được cung cấp
        async function loadLayoutWithScripts(layoutUrl, contentLoader, activeNavPage) {
            try {
                console.log('Loading admin layout from:', layoutUrl);

                // Fetch layout
                const response = await fetch(layoutUrl);
                const layoutHtml = await response.text();

                // Parse và execute scripts manually
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = layoutHtml;
                const scripts = tempDiv.querySelectorAll('script');

                // Inject layout
                document.getElementById('layoutContainer').innerHTML = layoutHtml;

                // Execute scripts manually
                scripts.forEach(script => {
                    if (script.src && !document.querySelector(`script[src="${script.src}"]`)) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        newScript.onload = () => console.log('External script loaded:', script.src);
                        document.head.appendChild(newScript);
                    } else if (!script.src) {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                    }
                });

                // Initialize UI sau khi load
                setTimeout(() => {
                    // Initialize Bootstrap components
                    document.querySelectorAll('.dropdown-toggle').forEach(el => {
                        new bootstrap.Dropdown(el);
                    });

                    // Set active nav nếu cần
                    if (activeNavPage && window.AdminLayout) {
                        window.AdminLayout.setActiveNav(activeNavPage);
                    }

                    // Load content
                    if (contentLoader) contentLoader();
                }, 500);

                console.log('Admin layout loaded successfully');

            } catch (error) {
                console.error('Error loading admin layout:', error);
                document.getElementById('layoutContainer').innerHTML =
                    '<div class="alert alert-danger">Không thể tải layout</div>';
            }
        }

        // Get order ID from URL
        function getOrderIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            const orderIndex = pathParts.indexOf('orders');
            if (orderIndex !== -1 && pathParts[orderIndex + 1]) {
                return pathParts[orderIndex + 1];
            }
            return null;
        }

        // Load page content
        async function loadPageContent() {
            console.log('=== LOADING ORDER DETAIL PAGE ===');

            const orderId = getOrderIdFromUrl();
            if (!orderId) {
                document.getElementById('pageContent').innerHTML = `
                    <div class="container py-4">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Không tìm thấy mã đơn hàng trong URL
                        </div>
                        <a href="/admin/orders" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                        </a>
                    </div>
                `;
                return;
            }

            // Show loading
            document.getElementById('pageContent').innerHTML = `
                <div class="container py-4">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tải chi tiết đơn hàng...</p>
                    </div>
                </div>
            `;

            try {
                // Load order detail
                const response = await fetch(`/admin/orders/api/${orderId}`);
                const result = await response.json();

                if (result.success) {
                    renderOrderDetail(result.data);
                } else {
                    document.getElementById('pageContent').innerHTML = `
                        <div class="container py-4">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${result.message}
                            </div>
                            <a href="/admin/orders" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                            </a>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading order detail:', error);
                document.getElementById('pageContent').innerHTML = `
                    <div class="container py-4">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Lỗi khi tải chi tiết đơn hàng
                        </div>
                        <a href="/admin/orders" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                        </a>
                    </div>
                `;
            }
        }

        // Render order detail
        function renderOrderDetail(order) {
            const contentHtml = `
                <div class="container py-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-file-invoice me-2"></i>Chi tiết đơn hàng</h2>
                            <p class="text-muted mb-0">Mã đơn hàng: <strong>${order.orderId || '#' + order.id}</strong></p>
                        </div>
                        <div>
                            <a href="/admin/orders" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại
                            </a>
                        </div>
                    </div>

                    <!-- Alert container -->
                    <div id="alertContainer"></div>

                    <div class="row">
                        <!-- Order Info -->
                        <div class="col-lg-8">
                            <!-- Order Status -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin đơn hàng</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td><strong>Mã đơn hàng:</strong></td>
                                                    <td>${order.orderId || '#' + order.id}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Ngày đặt:</strong></td>
                                                    <td>${formatDateTime(order.orderDate)}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Trạng thái:</strong></td>
                                                    <td>
                                                        <select class="form-select form-select-sm" onchange="updateOrderStatus(this.value)" data-current="${order.status}" style="width: 150px;">
                                                            <option value="PENDING" ${order.status === 'PENDING' ? 'selected' : ''}>Chờ xử lý</option>
                                                            <option value="SHIPPED" ${order.status === 'SHIPPED' ? 'selected' : ''}>Đã gửi hàng</option>
                                                            <option value="COMPLETED" ${order.status === 'COMPLETED' ? 'selected' : ''}>Hoàn thành</option>
                                                            <option value="CANCELED" ${order.status === 'CANCELED' ? 'selected' : ''}>Đã hủy</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Phương thức thanh toán:</strong></td>
                                                    <td>
                                                        <span class="badge bg-primary">${getPaymentMethodText(order.paymentMethod)}</span>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td><strong>Tổng tiền:</strong></td>
                                                    <td><h5 class="text-success mb-0">${formatCurrency(order.totalPrice)}</h5></td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Trạng thái thanh toán:</strong></td>
                                                    <td>${getPaymentStatusBadge(order.paymentStatus)}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Khách hàng:</strong></td>
                                                    <td>${order.user ? order.user.fullName || order.user.username : 'N/A'}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Email:</strong></td>
                                                    <td>${order.user ? order.user.email : 'N/A'}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Promotion Info (if exists) -->
                            ${order.promotionCode ? `
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-percent me-2"></i>Thông tin khuyến mãi</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td><strong>Mã giảm giá:</strong></td>
                                                    <td><span class="badge bg-success fs-6">${order.promotionCode}</span></td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Số tiền giảm:</strong></td>
                                                    <td><span class="text-success fw-bold">${formatCurrency(order.discountAmount || 0)}</span></td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="alert alert-success mb-0">
                                                <i class="fas fa-check-circle me-2"></i>
                                                Đã áp dụng mã giảm giá thành công
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>` : ''}

                            <!-- Order Items -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Sản phẩm đã đặt</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Sản phẩm</th>
                                                    <th>Đơn giá</th>
                                                    <th>Số lượng</th>
                                                    <th>Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${renderOrderItems(order.orderItems)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Info -->
                        <div class="col-lg-4">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Thông tin giao hàng</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Người nhận:</strong></label>
                                        <p class="mb-1">${order.shippingName || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Số điện thoại:</strong></label>
                                        <p class="mb-1">
                                            ${order.shippingPhone ?
                                                `<a href="tel:${order.shippingPhone}">${order.shippingPhone}</a>` :
                                                'N/A'
                                            }
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Địa chỉ:</strong></label>
                                        <p class="mb-1">${order.shippingAddress || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Action buttons -->
                            <div class="card shadow-sm">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Thao tác</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-secondary" onclick="printOrder()">
                                            <i class="fas fa-print me-2"></i>In đơn hàng
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            `;

            document.getElementById('pageContent').innerHTML = contentHtml;

            // Store order data globally
            window.currentOrder = order;
        }

        // Render order items
        function renderOrderItems(orderItems) {
            if (!orderItems || orderItems.length === 0) {
                return `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">Không có sản phẩm nào</p>
                        </td>
                    </tr>
                `;
            }

            const itemsHtml = orderItems.map(item => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                ${item.product && item.product.imageUrl ?
                                    `<img src="${item.product.imageUrl}" alt="Product" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` :
                                    `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>`
                                }
                            </div>
                            <div>
                                <h6 class="mb-1">${item.product ? item.product.name : 'Sản phẩm không xác định'}</h6>
                                <small class="text-muted">ID: ${item.product ? item.product.id : 'N/A'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>
                        <span class="badge bg-secondary">${item.quantity}</span>
                    </td>
                    <td><strong>${formatCurrency(item.price * item.quantity)}</strong></td>
                </tr>
            `).join('');

            // Add total rows
            const subtotal = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountAmount = window.currentOrder?.discountAmount || 0;
            const total = subtotal - discountAmount;

            let totalRows = `
                <tr class="table-light">
                    <td colspan="3" class="text-end"><strong>Tạm tính:</strong></td>
                    <td><strong>${formatCurrency(subtotal)}</strong></td>
                </tr>
            `;

            if (discountAmount > 0) {
                totalRows += `
                    <tr class="table-light">
                        <td colspan="3" class="text-end"><strong>Giảm giá (${window.currentOrder.promotionCode}):</strong></td>
                        <td><strong class="text-success">-${formatCurrency(discountAmount)}</strong></td>
                    </tr>
                `;
            }

            totalRows += `
                <tr class="table-active">
                    <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                    <td><strong class="text-success">${formatCurrency(total)}</strong></td>
                </tr>
            `;

            return itemsHtml + totalRows;
        }

        // Utility functions
        function formatDateTime(dateTime) {
            if (!dateTime) return 'N/A';
            const date = new Date(dateTime);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            if (!amount) return '0 ₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function getStatusBadge(status) {
            const statusConfig = {
                'PENDING': { class: 'bg-warning', text: 'Chờ xử lý' },
                'SHIPPED': { class: 'bg-secondary', text: 'Đã gửi hàng' },
                'COMPLETED': { class: 'bg-success', text: 'Hoàn thành' },
                'CANCELED': { class: 'bg-danger', text: 'Đã hủy' }
            };

            const config = statusConfig[status] || { class: 'bg-secondary', text: status };
            return `<span class="badge ${config.class}">${config.text}</span>`;
        }

        function getPaymentStatusBadge(status) {
            const statusConfig = {
                'UNPAID': { class: 'bg-warning', text: 'Chưa thanh toán' },
                'PAID': { class: 'bg-success', text: 'Đã thanh toán' },
                'FAILED': { class: 'bg-danger', text: 'Thất bại' }
            };

            const config = statusConfig[status] || { class: 'bg-secondary', text: status };
            return `<span class="badge ${config.class}">${config.text}</span>`;
        }

        function getPaymentMethodText(method) {
            const methodTexts = {
                'MOMO': 'MoMo',
                'COD': 'Thanh toán khi nhận hàng'
            };
            return methodTexts[method] || method;
        }

        // Action functions
        async function updateOrderStatus(newStatus) {
            const orderId = getOrderIdFromUrl();
            const dropdown = event.target;
            const currentStatus = dropdown.getAttribute('data-current');

            // If no change, return
            if (currentStatus === newStatus) {
                return;
            }

            // Show confirmation
            if (!confirm(`Bạn có chắc chắn muốn chuyển trạng thái thành "${getStatusText(newStatus)}"?`)) {
                // Reset dropdown to current status
                dropdown.value = currentStatus;
                return;
            }

            try {
                const response = await fetch(`/admin/orders/api/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Cập nhật trạng thái thành công');
                    // Update data attribute
                    dropdown.setAttribute('data-current', newStatus);

                    // Refresh page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', result.message);
                    // Reset dropdown to current status
                    dropdown.value = currentStatus;
                }

            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('danger', 'Lỗi khi cập nhật trạng thái');
                // Reset dropdown to current status
                dropdown.value = currentStatus;
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'PENDING': 'Chờ xử lý',
                'SHIPPED': 'Đã gửi hàng',
                'COMPLETED': 'Hoàn thành',
                'CANCELED': 'Đã hủy'
            };
            return statusTexts[status] || status;
        }

        function printOrder() {
            // Simple print function
            window.print();
        }

        // Show alert function
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;

            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('#alertContainer .alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Load layout and content when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM CONTENT LOADED ===');
            loadLayoutWithScripts('/admin/layouts/app.html', loadPageContent, 'orders');
        });
    </script>
</body>
</html>