<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Người dùng - Admin Panel</title>

    <!-- Load Bootstrap/jQuery trước khi load layout -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div id="layoutContainer"></div>

    <script>
        // Function to load layout with proper script execution
        async function loadLayoutWithScripts(layoutUrl, contentLoader, activeNavPage) {
            try {
                console.log('Loading layout from:', layoutUrl);

                // Fetch layout
                const response = await fetch(layoutUrl);
                const layoutHtml = await response.text();

                // Parse và execute scripts manually
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = layoutHtml;
                const scripts = tempDiv.querySelectorAll('script');

                // Inject layout
                document.getElementById('layoutContainer').innerHTML = layoutHtml;

                // Execute scripts manually
                scripts.forEach(script => {
                    if (script.src && !document.querySelector(`script[src="${script.src}"]`)) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        document.head.appendChild(newScript);
                    } else if (!script.src) {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                    }
                });

                // Initialize UI sau khi load
                setTimeout(() => {
                    console.log('Initializing UI components...');

                    // Initialize Bootstrap components
                    document.querySelectorAll('.dropdown-toggle').forEach(el => {
                        new bootstrap.Dropdown(el);
                    });

                    // Set active nav nếu cần
                    if (activeNavPage && window.AdminLayout) {
                        window.AdminLayout.setActiveNav(activeNavPage);
                    }

                    // Load content
                    if (contentLoader) contentLoader();
                }, 500);

            } catch (error) {
                console.error('Error loading layout:', error);
            }
        }

        // Load user detail page content
        function loadUserDetailContent() {
            console.log('Loading user detail content...');

            const pageContent = document.getElementById('pageContent');
            if (!pageContent) {
                console.error('pageContent element not found');
                return;
            }

            // Get user ID from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');

            if (!userId) {
                window.location.href = '/admin/users';
                return;
            }

            pageContent.innerHTML = `
                <!-- Page Header -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="/admin/users" class="text-decoration-none">Quản lý Người dùng</a>
                                </li>
                                <li class="breadcrumb-item active">Chi tiết Người dùng</li>
                            </ol>
                        </nav>
                        <h1 class="h3 mb-0 text-gray-800">Chi tiết Người dùng #${userId}</h1>
                    </div>
                    <div>
                        <button class="btn btn-secondary btn-sm" onclick="window.history.back()">
                            <i class="fas fa-arrow-left me-1"></i>Quay lại
                        </button>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Đang tải thông tin người dùng...</p>
                </div>

                <!-- User Detail Content -->
                <div id="userDetailContent" style="display: none;">
                    <!-- User Info Card -->
                    <div class="row">
                        <div class="col-xl-8">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                    <h6 class="m-0 font-weight-bold text-primary">Thông tin cá nhân</h6>
                                    <div id="userActions">
                                        <!-- Action buttons will be loaded here -->
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="userBasicInfo">
                                        <!-- User basic info will be loaded here -->
                                    </div>
                                </div>
                            </div>

                            <!-- User Activity Card -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Hoạt động gần đây</h6>
                                </div>
                                <div class="card-body">
                                    <div id="userActivity">
                                        <!-- User activity will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-4">
                            <!-- User Stats Card -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Thống kê</h6>
                                </div>
                                <div class="card-body">
                                    <div id="userStats">
                                        <!-- User stats will be loaded here -->
                                    </div>
                                </div>
                            </div>

                            <!-- User Status Card -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Trạng thái tài khoản</h6>
                                </div>
                                <div class="card-body">
                                    <div id="userStatusInfo">
                                        <!-- User status info will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">Không thể tải thông tin người dùng</h5>
                    <p class="text-muted" id="errorMessage">Có lỗi xảy ra khi tải dữ liệu</p>
                    <button class="btn btn-primary" onclick="UserDetailManager.loadUserDetail()">
                        <i class="fas fa-refresh me-1"></i>Thử lại
                    </button>
                </div>
            `;

            // Initialize user detail functionality
            initializeUserDetail(userId);
        }

        // Initialize user detail after content is loaded
        function initializeUserDetail(userId) {
            console.log('Initializing user detail for ID:', userId);

            // Create UserDetailManager and load data
            window.UserDetailManager = new UserDetailManager(userId);
            window.UserDetailManager.loadUserDetail();
        }

        // User Detail Manager Class
        class UserDetailManager {
            constructor(userId) {
                this.userId = userId;
                this.api = window.AdminUserAPI;
            }

            // Load user detail
            async loadUserDetail() {
                try {
                    console.log('Loading user detail for ID:', this.userId);

                    // Show loading
                    document.getElementById('loadingIndicator').style.display = 'block';
                    document.getElementById('userDetailContent').style.display = 'none';
                    document.getElementById('errorState').style.display = 'none';

                    // Make real API call
                    const response = await this.api.getUserById(this.userId);

                    if (response && response.success) {
                        this.renderUserDetail(response.data);
                        document.getElementById('userDetailContent').style.display = 'block';
                    } else {
                        this.showErrorState(response?.message || 'Không thể tải thông tin người dùng');
                    }

                } catch (error) {
                    console.error('Error loading user detail:', error);
                    this.showErrorState('Có lỗi xảy ra khi tải dữ liệu');
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }


            // Render user detail
            renderUserDetail(user) {
                // Render basic info
                document.getElementById('userBasicInfo').innerHTML = `
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">ID:</label>
                            <p class="mb-0">${user.id}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tên đăng nhập:</label>
                            <p class="mb-0">${user.username}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email:</label>
                            <p class="mb-0">${user.email}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Họ tên:</label>
                            <p class="mb-0">${user.fullName || '-'}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Số điện thoại:</label>
                            <p class="mb-0">${user.phone || '-'}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Địa chỉ:</label>
                            <p class="mb-0">${user.address || '-'}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Vai trò:</label>
                            <p class="mb-0">
                                <span class="badge bg-${user.role === 'ADMIN' ? 'danger' : 'primary'}">${user.role}</span>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Trạng thái:</label>
                            <p class="mb-0">
                                <span class="badge bg-${user.status === 'ACTIVE' ? 'success' : 'warning'}">${user.status}</span>
                            </p>
                        </div>
                    </div>
                `;

                // Render action buttons
                document.getElementById('userActions').innerHTML = `
                    <button class="btn btn-${user.status === 'ACTIVE' ? 'warning' : 'success'} btn-sm me-2"
                            onclick="UserDetailManager.toggleUserStatus('${user.status}')"
                            ${user.role === 'ADMIN' ? 'disabled' : ''}>
                        <i class="fas fa-${user.status === 'ACTIVE' ? 'lock' : 'unlock'} me-1"></i>
                        ${user.status === 'ACTIVE' ? 'Khóa tài khoản' : 'Kích hoạt'}
                    </button>
                    ${user.role !== 'ADMIN' ? `
                        <button class="btn btn-danger btn-sm" onclick="UserDetailManager.deleteUser()">
                            <i class="fas fa-trash me-1"></i>Xóa tài khoản
                        </button>
                    ` : ''}
                `;

                // Render stats
                document.getElementById('userStats').innerHTML = `
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="border-end">
                                <div class="h4 mb-0 text-primary">${user.totalOrders}</div>
                                <small class="text-muted">Đơn hàng</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border-end">
                                <div class="h4 mb-0 text-info">${user.totalCartItems}</div>
                                <small class="text-muted">Giỏ hàng</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-warning">${user.totalWishlistItems}</div>
                            <small class="text-muted">Yêu thích</small>
                        </div>
                    </div>
                `;

                // Render status info
                document.getElementById('userStatusInfo').innerHTML = `
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ngày tạo:</label>
                        <p class="mb-0">${new Date(user.createdAt).toLocaleString('vi-VN')}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cập nhật lần cuối:</label>
                        <p class="mb-0">${new Date(user.updatedAt).toLocaleString('vi-VN')}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Hoạt động:</label>
                        <p class="mb-0">
                            <span class="badge bg-${user.status === 'ACTIVE' ? 'success' : 'secondary'}">
                                ${user.status === 'ACTIVE' ? 'Đang hoạt động' : 'Không hoạt động'}
                            </span>
                        </p>
                    </div>
                `;

                // Render activity (mock data)
                document.getElementById('userActivity').innerHTML = `
                    <div class="timeline">
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <i class="fas fa-shopping-cart text-white" style="font-size: 12px;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="mb-1">Đã đặt đơn hàng mới</p>
                                    <small class="text-muted">2 giờ trước</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <i class="fas fa-heart text-white" style="font-size: 12px;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="mb-1">Thêm sản phẩm vào danh sách yêu thích</p>
                                    <small class="text-muted">1 ngày trước</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <i class="fas fa-sign-in-alt text-white" style="font-size: 12px;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="mb-1">Đăng nhập vào hệ thống</p>
                                    <small class="text-muted">3 ngày trước</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Show error state
            showErrorState(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorState').style.display = 'block';
            }

            // Toggle user status
            async toggleUserStatus(currentStatus) {
                const newStatus = currentStatus === 'ACTIVE' ? 'BLOCKED' : 'ACTIVE';
                const action = newStatus === 'ACTIVE' ? 'kích hoạt' : 'khóa';

                if (confirm(`Bạn có chắc chắn muốn ${action} tài khoản này?`)) {
                    console.log(`Toggling user ${this.userId} status to ${newStatus}`);

                    const response = await this.api.updateUserStatus(this.userId, newStatus);
                    if (response.success) {
                        this.api.showSuccessMessage(response.message);
                        // Reload user detail
                        this.loadUserDetail();
                    } else {
                        this.api.showErrorMessage(response.message);
                    }
                }
            }

            // Delete user
            async deleteUser() {
                if (confirm('Bạn có chắc chắn muốn xóa tài khoản này? Hành động này không thể hoàn tác.')) {
                    console.log(`Deleting user ${this.userId}`);

                    const response = await this.api.deleteUser(this.userId);
                    if (response.success) {
                        this.api.showSuccessMessage(response.message);
                        // Redirect back to user list
                        window.location.href = '/admin/users';
                    } else {
                        this.api.showErrorMessage(response.message);
                    }
                }
            }
        }

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load axios first, then user-api.js
            const axiosScript = document.createElement('script');
            axiosScript.src = 'https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js';
            axiosScript.onload = function() {
                console.log('axios loaded successfully');

                // Now load user-api.js
                const apiScript = document.createElement('script');
                apiScript.src = '/js/admin/user-api.js';
                apiScript.onload = function() {
                    console.log('user-api.js loaded successfully');
                    loadLayoutWithScripts('/admin/layouts/app.html', loadUserDetailContent, 'users');
                };
                apiScript.onerror = function() {
                    console.error('Failed to load user-api.js');
                    alert('Không thể tải API script. Vui lòng thử lại.');
                };
                document.head.appendChild(apiScript);
            };
            axiosScript.onerror = function() {
                console.error('Failed to load axios');
                alert('Không thể tải axios. Vui lòng thử lại.');
            };
            document.head.appendChild(axiosScript);
        });
    </script>
</body>
</html>