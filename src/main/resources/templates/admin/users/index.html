<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Người dùng - Admin Panel</title>

    <!-- Load Bootstrap/jQuery trước khi load layout -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div id="layoutContainer"></div>

    <script>
        // Function to load layout with proper script execution
        async function loadLayoutWithScripts(layoutUrl, contentLoader, activeNavPage) {
            try {
                console.log('Loading layout from:', layoutUrl);

                // Fetch layout
                const response = await fetch(layoutUrl);
                const layoutHtml = await response.text();

                // Parse và execute scripts manually
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = layoutHtml;
                const scripts = tempDiv.querySelectorAll('script');

                // Inject layout
                document.getElementById('layoutContainer').innerHTML = layoutHtml;

                // Execute scripts manually
                scripts.forEach(script => {
                    if (script.src && !document.querySelector(`script[src="${script.src}"]`)) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        document.head.appendChild(newScript);
                    } else if (!script.src) {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                    }
                });

                // Initialize UI sau khi load
                setTimeout(() => {
                    console.log('Initializing UI components...');

                    // Initialize Bootstrap components
                    document.querySelectorAll('.dropdown-toggle').forEach(el => {
                        new bootstrap.Dropdown(el);
                    });

                    // Set active nav nếu cần
                    if (activeNavPage && window.AdminLayout) {
                        window.AdminLayout.setActiveNav(activeNavPage);
                    }

                    // Load content
                    if (contentLoader) contentLoader();
                }, 500);

            } catch (error) {
                console.error('Error loading layout:', error);
            }
        }

        // Load user list page content
        function loadUserListContent() {
            console.log('Loading user list content...');

            const pageContent = document.getElementById('pageContent');
            if (!pageContent) {
                console.error('pageContent element not found');
                return;
            }

            pageContent.innerHTML = `
                <!-- Page Header -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">Quản lý Người dùng</h1>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="UserManager.showUserStats()">
                            <i class="fas fa-chart-bar me-1"></i>Thống kê
                        </button>
                        <button class="btn btn-info btn-sm" onclick="UserManager.exportUsers()">
                            <i class="fas fa-download me-1"></i>Xuất Excel
                        </button>
                    </div>
                </div>

                <!-- Filters & Search -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Bộ lọc & Tìm kiếm</h6>
                    </div>
                    <div class="card-body">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Vai trò</label>
                                <select class="form-select" id="roleFilter">
                                    <option value="">Tất cả vai trò</option>
                                    <option value="USER">Người dùng</option>
                                    <option value="ADMIN">Quản trị viên</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="ACTIVE">Hoạt động</option>
                                    <option value="BLOCKED">Bị khóa</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tìm kiếm</label>
                                <input type="text" class="form-control" id="searchInput"
                                       placeholder="Tên đăng nhập, email, họ tên, số điện thoại...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-1"></i>Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Danh sách Người dùng</h6>
                        <div>
                            <button class="btn btn-danger btn-sm" id="bulkDeleteBtn" style="display: none;"
                                    onclick="UserManager.bulkDeleteUsers()">
                                <i class="fas fa-trash me-1"></i>Xóa đã chọn
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading indicator -->
                        <div id="loadingIndicator" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                            <p class="mt-2">Đang tải dữ liệu...</p>
                        </div>

                        <!-- Users table -->
                        <div id="usersTableContainer" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="40">
                                                <input type="checkbox" id="selectAllUsers" class="form-check-input">
                                            </th>
                                            <th>ID</th>
                                            <th>Tên đăng nhập</th>
                                            <th>Email</th>
                                            <th>Họ tên</th>
                                            <th>Số điện thoại</th>
                                            <th>Vai trò</th>
                                            <th>Trạng thái</th>
                                            <th>Ngày tạo</th>
                                            <th width="120">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav aria-label="User pagination" id="paginationContainer">
                                <!-- Pagination will be generated here -->
                            </nav>
                        </div>

                        <!-- Empty state -->
                        <div id="emptyState" class="text-center py-5" style="display: none;">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Không tìm thấy người dùng nào</h5>
                            <p class="text-muted">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                        </div>
                    </div>
                </div>

                <!-- User Detail Modal -->
                <div class="modal fade" id="userDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết Người dùng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="userDetailContent">
                                <!-- User details will be loaded here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Stats Modal -->
                <div class="modal fade" id="userStatsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Thống kê Người dùng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="userStatsContent">
                                <!-- Stats will be loaded here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize user management functionality
            initializeUserManagement();
        }

        // Initialize user management after content is loaded
        function initializeUserManagement() {
            console.log('Initializing user management...');

            // Initialize form handling
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    UserManager.loadUsers();
                });
            }

            // Initialize select all checkbox
            const selectAllUsers = document.getElementById('selectAllUsers');
            if (selectAllUsers) {
                selectAllUsers.addEventListener('change', UserManager.toggleSelectAll);
            }

            // Load initial data - Use EnhancedUserManager for real API calls
            if (window.EnhancedUserManager) {
                window.UserManager = new window.EnhancedUserManager();
            }
            UserManager.loadUsers();
        }

        // User Management Object
        window.UserManager = {
            currentPage: 0,
            pageSize: 10,
            totalPages: 0,
            selectedUsers: new Set(),

            // Load users with filters
            async loadUsers(page = 0) {
                try {
                    this.currentPage = page;

                    // Show loading
                    document.getElementById('loadingIndicator').style.display = 'block';
                    document.getElementById('usersTableContainer').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'none';

                    // Get filter values
                    const role = document.getElementById('roleFilter')?.value || '';
                    const status = document.getElementById('statusFilter')?.value || '';
                    const search = document.getElementById('searchInput')?.value || '';

                    // Build query params
                    const params = new URLSearchParams({
                        page: page,
                        size: this.pageSize,
                        sortBy: 'createdAt',
                        sortDir: 'desc'
                    });

                    if (role) params.append('role', role);
                    if (status) params.append('status', status);
                    if (search) params.append('search', search);

                    console.log('Loading users with params:', params.toString());

                    // Make API call (simulate for now)
                    const response = await this.fetchUsers(params);

                    if (response && response.success) {
                        this.renderUsers(response.data);
                        this.renderPagination(response.data);
                    } else {
                        this.showEmptyState();
                    }

                } catch (error) {
                    console.error('Error loading users:', error);
                    this.showEmptyState();
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            },

            // Simulate API call for now
            async fetchUsers(params) {
                // TODO: Replace with actual API call
                // For now, return mock data
                await new Promise(resolve => setTimeout(resolve, 1000));

                return {
                    success: true,
                    data: {
                        content: [
                            {
                                id: 1,
                                username: 'john_doe',
                                email: 'john@example.com',
                                fullName: 'John Doe',
                                phone: '0123456789',
                                role: 'USER',
                                status: 'ACTIVE',
                                createdAt: '2024-01-15T10:30:00'
                            },
                            {
                                id: 2,
                                username: 'admin',
                                email: 'admin@example.com',
                                fullName: 'Administrator',
                                phone: '0987654321',
                                role: 'ADMIN',
                                status: 'ACTIVE',
                                createdAt: '2024-01-10T09:00:00'
                            }
                        ],
                        page: 0,
                        size: 10,
                        totalElements: 2,
                        totalPages: 1,
                        first: true,
                        last: true
                    }
                };
            },

            // Render users table
            renderUsers(data) {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;

                if (data.content && data.content.length > 0) {
                    tbody.innerHTML = data.content.map(user => `
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input user-checkbox"
                                       value="${user.id}" onchange="UserManager.toggleUserSelection(${user.id})">
                            </td>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.fullName || '-'}</td>
                            <td>${user.phone || '-'}</td>
                            <td><span class="badge bg-${user.role === 'ADMIN' ? 'danger' : 'primary'}">${user.role}</span></td>
                            <td><span class="badge bg-${user.status === 'ACTIVE' ? 'success' : 'warning'}">${user.status}</span></td>
                            <td>${new Date(user.createdAt).toLocaleDateString('vi-VN')}</td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="UserManager.viewUserDetail(${user.id})"
                                        title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-${user.status === 'ACTIVE' ? 'warning' : 'success'} btn-sm"
                                        onclick="UserManager.toggleUserStatus(${user.id}, '${user.status}')"
                                        title="${user.status === 'ACTIVE' ? 'Khóa' : 'Kích hoạt'}">
                                    <i class="fas fa-${user.status === 'ACTIVE' ? 'lock' : 'unlock'}"></i>
                                </button>
                                ${user.role !== 'ADMIN' ? `
                                    <button class="btn btn-danger btn-sm" onclick="UserManager.deleteUser(${user.id})"
                                            title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('');

                    document.getElementById('usersTableContainer').style.display = 'block';
                } else {
                    this.showEmptyState();
                }
            },

            // Render pagination
            renderPagination(data) {
                const container = document.getElementById('paginationContainer');
                if (!container) return;

                this.totalPages = data.totalPages;

                if (data.totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHtml = '<ul class="pagination justify-content-center">';

                // Previous button
                paginationHtml += `
                    <li class="page-item ${data.first ? 'disabled' : ''}">
                        <button class="page-link" onclick="UserManager.loadUsers(${data.page - 1})"
                                ${data.first ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </li>
                `;

                // Page numbers
                for (let i = Math.max(0, data.page - 2); i <= Math.min(data.totalPages - 1, data.page + 2); i++) {
                    paginationHtml += `
                        <li class="page-item ${i === data.page ? 'active' : ''}">
                            <button class="page-link" onclick="UserManager.loadUsers(${i})">${i + 1}</button>
                        </li>
                    `;
                }

                // Next button
                paginationHtml += `
                    <li class="page-item ${data.last ? 'disabled' : ''}">
                        <button class="page-link" onclick="UserManager.loadUsers(${data.page + 1})"
                                ${data.last ? 'disabled' : ''}>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </li>
                `;

                paginationHtml += '</ul>';
                container.innerHTML = paginationHtml;
            },

            // Show empty state
            showEmptyState() {
                document.getElementById('usersTableContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            },

            // Toggle select all users
            toggleSelectAll() {
                const selectAll = document.getElementById('selectAllUsers');
                const userCheckboxes = document.querySelectorAll('.user-checkbox');

                UserManager.selectedUsers.clear();

                userCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                    if (selectAll.checked) {
                        UserManager.selectedUsers.add(parseInt(checkbox.value));
                    }
                });

                UserManager.updateBulkDeleteButton();
            },

            // Toggle user selection
            toggleUserSelection(userId) {
                if (this.selectedUsers.has(userId)) {
                    this.selectedUsers.delete(userId);
                } else {
                    this.selectedUsers.add(userId);
                }
                this.updateBulkDeleteButton();
                this.updateSelectAllCheckbox();
            },

            // Update bulk delete button visibility
            updateBulkDeleteButton() {
                const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                if (bulkDeleteBtn) {
                    bulkDeleteBtn.style.display = this.selectedUsers.size > 0 ? 'inline-block' : 'none';
                }
            },

            // Update select all checkbox state
            updateSelectAllCheckbox() {
                const selectAll = document.getElementById('selectAllUsers');
                const userCheckboxes = document.querySelectorAll('.user-checkbox');

                if (selectAll && userCheckboxes.length > 0) {
                    const checkedCount = Array.from(userCheckboxes).filter(cb => cb.checked).length;
                    selectAll.checked = checkedCount === userCheckboxes.length;
                    selectAll.indeterminate = checkedCount > 0 && checkedCount < userCheckboxes.length;
                }
            },

            // View user detail
            async viewUserDetail(userId) {
                console.log('Viewing user detail:', userId);
                // TODO: Implement user detail modal
                alert('Tính năng xem chi tiết user sẽ được implement sau');
            },

            // Toggle user status
            async toggleUserStatus(userId, currentStatus) {
                const newStatus = currentStatus === 'ACTIVE' ? 'BLOCKED' : 'ACTIVE';
                const action = newStatus === 'ACTIVE' ? 'kích hoạt' : 'khóa';

                if (confirm(`Bạn có chắc chắn muốn ${action} người dùng này?`)) {
                    console.log(`Toggling user ${userId} status to ${newStatus}`);
                    // TODO: Implement API call
                    alert(`Tính năng ${action} user sẽ được implement sau`);
                }
            },

            // Delete user
            async deleteUser(userId) {
                if (confirm('Bạn có chắc chắn muốn xóa người dùng này?')) {
                    console.log('Deleting user:', userId);
                    // TODO: Implement API call
                    alert('Tính năng xóa user sẽ được implement sau');
                }
            },

            // Bulk delete users
            async bulkDeleteUsers() {
                if (this.selectedUsers.size === 0) return;

                if (confirm(`Bạn có chắc chắn muốn xóa ${this.selectedUsers.size} người dùng đã chọn?`)) {
                    console.log('Bulk deleting users:', Array.from(this.selectedUsers));
                    // TODO: Implement API call
                    alert('Tính năng xóa nhiều user sẽ được implement sau');
                }
            },

            // Show user stats
            async showUserStats() {
                console.log('Showing user stats');
                // TODO: Implement stats modal
                alert('Tính năng thống kê user sẽ được implement sau');
            },

            // Export users
            async exportUsers() {
                console.log('Exporting users');
                // TODO: Implement export functionality
                alert('Tính năng xuất Excel sẽ được implement sau');
            }
        };

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load axios first, then user-api.js
            const axiosScript = document.createElement('script');
            axiosScript.src = 'https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js';
            axiosScript.onload = function() {
                console.log('axios loaded successfully');

                // Now load user-api.js
                const apiScript = document.createElement('script');
                apiScript.src = '/js/admin/user-api.js';
                apiScript.onload = function() {
                    console.log('user-api.js loaded successfully');
                    loadLayoutWithScripts('/admin/layouts/app.html', loadUserListContent, 'users');
                };
                apiScript.onerror = function() {
                    console.error('Failed to load user-api.js, using mock data');
                    loadLayoutWithScripts('/admin/layouts/app.html', loadUserListContent, 'users');
                };
                document.head.appendChild(apiScript);
            };
            axiosScript.onerror = function() {
                console.error('Failed to load axios, using mock data');
                loadLayoutWithScripts('/admin/layouts/app.html', loadUserListContent, 'users');
            };
            document.head.appendChild(axiosScript);
        });
    </script>
</body>
</html>