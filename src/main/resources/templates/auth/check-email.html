<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm Tra Email - Electronic Store</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/auth.css}" rel="stylesheet">
</head>
<body class="auth-body">
    <!-- Brand Header -->
    <nav class="navbar navbar-light bg-transparent py-3">
        <div class="container">
            <a class="navbar-brand text-primary fw-bold fs-3" th:href="@{/}">
                <i class="fas fa-laptop me-2"></i>Electronic Store
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="auth-main">
        <div class="auth-card">
            <div class="auth-card-header text-center">
                <div class="mb-3">
                    <i class="fas fa-envelope text-primary" style="font-size: 4rem;"></i>
                </div>
                <h3><i class="fas fa-envelope-open-text me-2"></i>Kiểm Tra Email Của Bạn</h3>
                <p class="mb-0 mt-2 opacity-75">Chúng tôi đã gửi link xác thực đến email của bạn</p>
            </div>

            <div class="auth-card-body text-center">
                <!-- Alert messages -->
                <div id="alertContainer"></div>

                <!-- Email sent message -->
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-paper-plane me-2"></i>
                    <strong>Đã gửi link xác thực đến email:</strong><br>
                    <span class="fs-5 fw-bold" id="userEmail" th:text="${email}">user@example.com</span>
                </div>

                <div class="mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-clock me-2"></i>Còn lại: <span id="countdown" class="text-danger fw-bold">15:00</span>
                    </h5>
                    <p class="text-muted mb-4">
                        Vui lòng kiểm tra hộp thư email và nhấp vào link xác thực để kích hoạt tài khoản.
                        <br><small>Link xác thực sẽ hết hạn sau 15 phút.</small>
                    </p>

                    <div class="text-start">
                        <h6 class="mb-3">Hướng dẫn:</h6>
                        <ol class="text-muted">
                            <li class="mb-2">Mở ứng dụng email trên điện thoại hoặc trình duyệt</li>
                            <li class="mb-2">Tìm email từ <strong>Electronic Store</strong></li>
                            <li class="mb-2">Nhấp vào nút <strong>"Xác thực tài khoản"</strong></li>
                            <li class="mb-2">Quay lại đây để đăng nhập</li>
                        </ol>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <small><strong>Lưu ý:</strong> Kiểm tra cả thư mục Spam/Junk nếu không thấy email trong hộp thư chính.</small>
                        </div>
                    </div>
                </div>

                <!-- Resend Button -->
                <div class="d-grid gap-2 mb-3">
                    <button type="button" class="btn btn-outline-primary" id="resendBtn" onclick="resendEmail()">
                        <i class="fas fa-redo me-2"></i>Gửi Lại Email Xác Thực
                    </button>
                    <a th:href="@{/auth/login}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Về Trang Đăng Nhập
                    </a>
                </div>

                <!-- Additional actions -->
                <div class="text-center">
                    <div class="d-flex align-items-center my-3">
                        <hr class="flex-grow-1">
                        <span class="px-3 text-muted small">HOẶC</span>
                        <hr class="flex-grow-1">
                    </div>

                    <p class="mb-3 text-muted">Email không đúng?</p>
                    <a th:href="@{/auth/register}" class="btn btn-outline-primary">
                        <i class="fas fa-user-plus me-2"></i>Đăng Ký Lại
                    </a>
                </div>

                <div class="text-center mt-4">
                    <small class="text-muted">
                        <a th:href="@{/}" class="text-decoration-none">
                            <i class="fas fa-arrow-left me-1"></i>Về trang chủ
                        </a>
                    </small>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="auth-footer text-center py-3">
        <div class="container">
            <small class="text-muted">
                &copy; 2024 Electronic Store. All rights reserved.
            </small>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script th:inline="javascript">
        // Initialize countdown (15 minutes = 900 seconds)
        let timeLeft = 900;
        let countdownTimer;

        // Get email from URL parameters or Thymeleaf
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email') || /*[[${email}]]*/ 'user@example.com';

        // Update email display
        document.getElementById('userEmail').textContent = email;

        function startCountdown() {
            countdownTimer = setInterval(function() {
                timeLeft--;

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;

                document.getElementById('countdown').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById('countdown').textContent = '00:00';
                    document.getElementById('countdown').className = 'text-danger fw-bold';
                    showAlert('warning', 'Link xác thực đã hết hạn. Vui lòng gửi lại email xác thực.');
                }
            }, 1000);
        }

        // Resend email function
        async function resendEmail() {
            const resendBtn = document.getElementById('resendBtn');

            // Disable button and show loading
            resendBtn.disabled = true;
            resendBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2"></span>
                Đang gửi...
            `;

            try {
                const response = await axios.post('/api/auth/resend-verification', {
                    email: email
                });

                if (response.data.success) {
                    showAlert('success', 'Email xác thực đã được gửi lại thành công! Vui lòng kiểm tra hộp thư.');

                    // Reset countdown
                    timeLeft = 900;
                    clearInterval(countdownTimer);
                    startCountdown();
                } else {
                    showAlert('danger', response.data.message || 'Không thể gửi lại email. Vui lòng thử lại!');
                }
            } catch (error) {
                console.error('Resend email error:', error);
                if (error.response && error.response.data) {
                    showAlert('danger', error.response.data.message || 'Không thể gửi lại email');
                } else {
                    showAlert('danger', 'Không thể kết nối đến server. Vui lòng thử lại!');
                }
            } finally {
                // Re-enable button
                resendBtn.disabled = false;
                resendBtn.innerHTML = `
                    <i class="fas fa-redo me-2"></i>Gửi Lại Email Xác Thực
                `;
            }
        }

        // Show alert function
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Auto hide after 5 seconds
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);

            // Scroll to top
            alertContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Start countdown when page loads
        window.addEventListener('load', function() {
            startCountdown();
        });

        // Check for verification success from URL parameters
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const verified = urlParams.get('verified');

            if (verified === 'success') {
                showAlert('success', 'Email đã được xác thực thành công! Bạn có thể đăng nhập ngay bây giờ.');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
            } else if (verified === 'error') {
                const message = urlParams.get('message') || 'Có lỗi xảy ra khi xác thực email';
                showAlert('danger', message);
            }
        });
    </script>
</body>
</html>